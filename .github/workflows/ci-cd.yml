name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  SERVICES: backend,transactions,studentportfolio,syncer
  OWNER: ashmandeepkaur
  TARGET_BRANCH: main

jobs:
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, transactions, studentportfolio, syncer]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "./${{ matrix.service }}/Dockerfile" ]; then
            echo "build=true" >> "$GITHUB_OUTPUT"
          else
            echo "build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to GHCR
        if: steps.check.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.OWNER }}
          password: ${{ secrets.CR_PAT }}

      - name: Set up Buildx
        if: steps.check.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Image
        if: steps.check.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ github.event.repository.name }}-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ github.event.repository.name }}-${{ matrix.service }}:${{ github.sha }}
          provenance: false
          sbom: false

  update-gitops:
    name: Update GitOps manifests
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Debug secrets (not printing actual values)
        run: |
          echo "GITOPS_REPO length: ${#GITOPS_REPO}"
          echo "GITOPS_PAT exists: $([[ -n "$GITOPS_PAT" ]] && echo yes || echo no)"
        env:
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
          GITOPS_PAT: ${{ secrets.GITOPS_PAT }}

      - name: Clone GitOps Repo
        run: |
          set -euo pipefail

          echo "Cloning GitOps repo: $GITOPS_REPO"

          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git clone "https://${GITOPS_PAT}@github.com/${GITOPS_REPO}.git" gitops || (
            echo "GitOps repo not found â€” creating a new one"
            mkdir gitops
            cd gitops
            git init
            git remote add origin "https://${GITOPS_PAT}@github.com/${GITOPS_REPO}.git"
            git checkout -b "${TARGET_BRANCH}"
          )

      - name: Update manifests
        run: |
          cd gitops

          cp -R "${GITHUB_WORKSPACE}/k8s" ./ || mkdir -p k8s

          find k8s -type f -name "*deployment*.yaml" -print0 | \
            xargs -0 sed -i -E \
              "s|(image:\s*ghcr\.io/.*/${{ github.event.repository.name }}-[a-z0-9._-]+:).*|\\1${GITHUB_SHA}|g"

          git add -A
          git commit -m "Update GitOps manifests to image tag ${GITHUB_SHA}" || echo "No changes"

      - name: Push changes
        run: |
          cd gitops
          git push -u origin "${TARGET_BRANCH}"
